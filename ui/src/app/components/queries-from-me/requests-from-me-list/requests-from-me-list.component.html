<div>
  <table *ngIf="requests" class="table">
    <caption>Requests</caption>
    <thead>
      <tr>
        <th></th>
        <th></th>
        <th>
          <button class="btn btn-default btn-block pull-right" (click)="archiveClick()"><i class="fa fa-archive"></i> {{ showArchive ? 'Hide Archive' : 'Show Archive' }}</button>
        </th>
      </tr>
    </thead>
    <thead>
      <tr>
        <th>Request</th>
        <th>Date/Time</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody *ngFor="let requestGroup of (requestGroups | mapValues)">
      <tr [ngClass]="{'archived-row' : requestGroup.show != null && !requestGroup.show}"  *ngIf="showArchive || requestGroup.show == null || requestGroup.show">
        <td (click)="requestGroup.active = !requestGroup.active"><i class="fa pointer" [ngClass]="{'fa-plus-square-o': !requestGroup.active, 'fa-minus-square-o': requestGroup.active}"></i> {{ requestGroup.val[0].inquiry.inquiryName }}</td>
        <td>{{ requestGroup.val[0].sentTimestamp | date:'yyyy-MM-dd h:mm a' }}</td>
        <td><button class="btn btn-default" (click)="onArchive(requestGroup, $event)" title="Archive"><i class="fa fa-archive"></i></button></td>
      </tr>
      <tr *ngIf="requestGroup.active">
        <td colspan="4">
          <p (click)="requestGroup.showingDetails = !requestGroup.showingDetails">Show Details <i class="fa" [ngClass]="{'fa-chevron-circle-down': !requestGroup.showingDetails, 'fa-chevron-circle-up': requestGroup.showingDetails}" aria-hidden="true"></i></p>
          <div *ngIf="requestGroup.showingDetails" class="box box-solid">
            <div class="box-body">
                <form class="form-horizontal">
                    <div>
                      <div class="form-group">
                        <label class="col-sm-2 control-label">Requester</label>
                        <div class="col-sm-10" style="padding-top: 7px">
                          {{ requestGroup.val[0].requester?.realName }}
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="col-sm-2 control-label">Description</label>
                        <div class="col-sm-10" style="padding-top: 7px">
                          {{ requestGroup.val[0].inquiry.inquiryDescription }}
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="col-sm-2 control-label">Code</label>
                        <div class="col-sm-10" style="padding-top: 7px">
                          {{ requestGroup.val[0].inquiry.code[0].code }}
                        </div>
                      </div>
                    </div>
                  </form>
            </div>
            <!-- /.box-body -->
          </div>
          <table class="table table-condensed table-striped">
            <thead>
              <tr>
                <th>Site</th>
                <th>Status</th>
                <th>Date/Time</th>
                <th>Result</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let request of requestGroup.val">
                <td>{{ request.requestSite.name }}</td>
                <td>{{ request.responses[0]?.status }}</td>
                <td>{{ request.responses[0]?.replyTimestamp | date:'yyyy-MM-dd h:mm a' }}</td>
                <td>{{ getRequestResult(request.responses[0]) }}
                    <i *ngIf="!['ERROR', 'COMPLETED', 'STALLED', 'PENDING', 'DENIED'].includes(request.responses[0]?.status) && !request.responses[0]?.hasError" class="fa fa-circle-o-notch fa-spin fa-1x fa-fw"></i>
                    <span *ngIf="request.responses[0]?.hasError" class="pull-right-container">
                      <small class="label bg-red">Network Error</small>
                    </span>
                    <a title="{{ getFilePaths(request.responses[0]) }}" data-toggle="tooltip" data-placement="top"><i *ngIf="request.responses[0]?.files" class="fa fa-question-circle"></i></a>
                </td>
                <td>
                  <button *ngIf="request.inquiry.queryType === 'AGGREGATE'" [disabled]="!request.responses[0]?.downloadAvailable" class="btn btn-primary btn-xs" (click)="requestData(request)">Request Data</button>
                </td>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
    </tbody>
  </table>
  <div *ngIf="!requests" class="row">
    <div class="col-md-4 col-md-offset-4 text-center">
      <span>Loading requests...</span><br />
      <i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i>
    </div>
  </div>
</div>
